# TD-002 阶段2：跨币种领先滞后特征实验 (v2.7-cross-pair)

**创建日期**: 2025-11-16  
**状态**: 📋 计划中  
**前置依赖**: v2.6-multifreq-full (AUC=0.5806±0.0028)

---

## 实验目标

将AUC从v2.6的0.5806提升至**0.60+**（目标增量：+0.02~+0.04）

---

## 核心假设

**假设1：BTC价格领先效应**
- BTC作为加密货币市场的"风向标"，其价格变化通常领先其他币种
- 当BTC上涨时，其他币种（ETH/BNB/SOL/ADA）通常在1-4小时后跟随上涨
- 可以使用BTC的历史价格变化率作为其他币种的预测特征

**假设2：市场整体趋势**
- 当市场整体上涨时（多数币种同时上涨），单个币种继续上涨的概率更高
- 可以使用市值加权的市场整体趋势指标作为预测特征

**假设3：币种间相关性**
- BTC/ETH价格相关性在不同市场阶段会变化
- 高相关性时期，ETH更容易跟随BTC；低相关性时期，ETH可能独立走势
- 可以使用滚动窗口计算的相关性作为预测特征

---

## 新增特征列表

### 特征组1：BTC领先指标（5个特征）

| 特征名 | 计算方法 | 适用币种 | 说明 |
|--------|---------|---------|------|
| `btc_return_1h_lag` | BTC在t-1时刻的1h收益率 | ETH/BNB/SOL/ADA | BTC滞后1小时的价格变化 |
| `btc_return_2h_lag` | BTC在t-2时刻的1h收益率 | ETH/BNB/SOL/ADA | BTC滞后2小时的价格变化 |
| `btc_return_4h_lag` | BTC在t-4时刻的1h收益率 | ETH/BNB/SOL/ADA | BTC滞后4小时的价格变化 |
| `btc_return_24h_lag` | BTC在t-24时刻的1h收益率 | ETH/BNB/SOL/ADA | BTC滞后24小时的价格变化 |
| `btc_trend_4h` | BTC最近4小时的线性回归斜率 | ETH/BNB/SOL/ADA | BTC短期趋势强度 |

**注意**：BTC本身不使用这些特征（避免自相关）

### 特征组2：ETH领先指标（2个特征）

| 特征名 | 计算方法 | 适用币种 | 说明 |
|--------|---------|---------|------|
| `eth_return_1h_lag` | ETH在t-1时刻的1h收益率 | BNB/SOL/ADA | ETH滞后1小时的价格变化 |
| `eth_return_2h_lag` | ETH在t-2时刻的1h收益率 | BNB/SOL/ADA | ETH滞后2小时的价格变化 |

**注意**：BTC和ETH本身不使用这些特征

### 特征组3：市场整体趋势（2个特征）

| 特征名 | 计算方法 | 适用币种 | 说明 |
|--------|---------|---------|------|
| `market_return_1h` | 5个币种市值加权的1h收益率 | 全部 | 市场整体趋势 |
| `market_bullish_ratio` | 5个币种中1h收益率>0的比例 | 全部 | 市场多头强度 |

### 特征组4：币种间相关性（2个特征）

| 特征名 | 计算方法 | 适用币种 | 说明 |
|--------|---------|---------|------|
| `btc_eth_corr_24h` | BTC/ETH价格的滚动24h相关系数 | ETH | BTC-ETH相关性 |
| `btc_target_corr_24h` | BTC与目标币种的滚动24h相关系数 | BNB/SOL/ADA | BTC与目标币种相关性 |

---

## 实现步骤

### 步骤1：扩展数据加载器（30分钟）

**文件**: `services/decision_engine/scripts/real_data_loader.py`

**修改内容**:
1. 添加`load_klines_cross_pair()`方法
2. 加载所有5个币种的K线数据（而非单个币种）
3. 对齐时间戳，确保所有币种在同一时刻都有数据
4. 返回格式：`Dict[str, List[Dict]]`（币种名 -> K线列表）

### 步骤2：扩展特征工程（45分钟）

**文件**: `services/decision_engine/app/services/feature_engineer.py`

**修改内容**:
1. 添加`calculate_features_cross_pair()`方法
2. 输入：目标币种的K线 + 所有币种的K线字典
3. 计算11个新特征（根据币种动态选择适用特征）
4. 返回：19个原有特征 + 最多11个新特征 = 最多30个特征

### 步骤3：创建训练脚本v2.7（30分钟）

**文件**: `services/decision_engine/scripts/train_xgboost_v2_7.py`

**修改内容**:
1. 复制`train_xgboost_v2_6.py`
2. 修改数据加载逻辑，调用`load_klines_cross_pair()`
3. 修改特征计算逻辑，调用`calculate_features_cross_pair()`
4. 添加`--seed`参数支持（复用v2.6的参数化）
5. 输出文件命名：`xgboost_signal_confidence_v2_7_seed_{seed}.pkl`

### 步骤4：训练和稳定性验证（60分钟）

1. 运行单次训练（seed=42）：`python train_xgboost_v2_7.py --seed 42`
2. 检查AUC是否提升（目标：≥0.60）
3. 如果AUC≥0.60，运行稳定性验证：`python run_stability_test_v2_7.py`
4. 分析阈值稳定性：`python analyze_thresholds_v2_7.py`

### 步骤5：与v2.6对比分析（15分钟）

**创建脚本**: `services/decision_engine/scripts/compare_v2_6_v2_7.py`

**输出内容**:
- AUC增量：v2.7 - v2.6
- 特征重要性对比（新特征的贡献度）
- 阈值稳定性对比
- 最终结论：是否值得保留跨币种特征

---

## 成功标准

### 必须满足（否则回退到v2.6）

1. **AUC提升≥0.015**：v2.7的AUC均值 ≥ 0.5956（v2.6的0.5806 + 0.015）
2. **阈值稳定性不恶化**：v2.7的阈值标准差 ≤ 0.05
3. **无过拟合**：v2.7的AUC标准差 ≤ 0.005

### 理想目标

1. **AUC≥0.60**：达到GOOD级别
2. **阈值标准差<0.04**：决策边界更稳定
3. **新特征重要性>10%**：跨币种特征确实有贡献

---

## 风险与缓解

### 风险1：数据对齐问题

**风险**：不同币种的K线时间戳可能不完全对齐（缺失数据）

**缓解**：
- 使用前向填充（forward fill）填补缺失值
- 如果某个币种缺失数据过多（>10%），排除该币种

### 风险2：特征泄露

**风险**：使用未来数据计算跨币种特征

**缓解**：
- 严格使用滞后特征（lag features）
- 在t时刻，只使用t-1、t-2、t-4等历史时刻的其他币种数据
- 运行`diagnose_lookahead_bias.py`验证

### 风险3：AUC提升不足

**风险**：跨币种特征贡献度低，AUC提升<0.015

**决策**：
- 如果AUC提升<0.015，放弃跨币种特征，直接进入阶段3（成交量异常特征）
- 不强行保留无效特征

---

## 时间预估

| 步骤 | 预估时间 | 累计时间 |
|------|---------|---------|
| 步骤1：扩展数据加载器 | 30分钟 | 30分钟 |
| 步骤2：扩展特征工程 | 45分钟 | 75分钟 |
| 步骤3：创建训练脚本 | 30分钟 | 105分钟 |
| 步骤4：训练和稳定性验证 | 60分钟 | 165分钟 |
| 步骤5：对比分析 | 15分钟 | 180分钟 |
| **总计** | **3小时** | - |

---

## 下一步

**立即执行**: 开始步骤1（扩展数据加载器）

**如果成功**: 进入阶段3（成交量异常特征）

**如果失败**: 分析失败原因，考虑其他特征类别（资金费率、链上数据）

